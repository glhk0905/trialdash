<!DOCTYPE html>
<html lang="zh-HK">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Dashboard Bï½œç¸½è¦½</title>

<style>
body{font-family:Arial;background:#000;color:#fff;margin:0;padding:14px}
h2{margin:6px 0}
button{
  background:#222;color:#fff;border:none;
  padding:8px 14px;margin:4px;
  border-radius:8px;font-size:14px
}
button.active{background:#4CAF50}
.block{border:1px solid #333;border-radius:12px;padding:12px;margin-bottom:14px}
.team{margin-left:14px;margin-top:6px}
.member{
  display:inline-block;
  padding:4px 8px;
  border-radius:6px;
  margin:3px;
  font-size:14px
}
.green{background:#2E7D32}
.orange{background:#EF6C00}
.red{background:#B71C1C}
.small{font-size:13px;color:#aaa}

#pinLock{
 position:fixed;inset:0;background:#000;
 display:flex;flex-direction:column;
 justify-content:center;align-items:center
}
input{font-size:20px;padding:8px;width:120px;text-align:center}
</style>
</head>

<body>

<!-- PIN Lock -->
<div id="pinLock">
  <h2>ğŸ” è¼¸å…¥ PIN</h2>
  <input id="pinInput" type="password" maxlength="4">
  <button onclick="checkPin()">é€²å…¥</button>
  <div id="pinError" class="small"></div>
</div>

<h2>ğŸ“Š Dashboard B</h2>

<div>
  <button id="btn-team" class="active" onclick="switchView('team')">ä¾éšŠä¼æª¢è¦–</button>
  <button id="btn-event" onclick="switchView('event')">ä¾é …ç›®æª¢è¦–</button>
</div>

<div id="view"></div>
<div class="small" id="update"></div>

<script>
const PIN="9838";

/* ====== Sheet ====== */
const SHEET_ID="1dwK703awpcqW6A3BofDA8cjNSlER2C2Tz5wIu7wr6XQ";
const SHEET_NAME="è¡¨å–®å›æ‡‰ 1";
const CSV_URL=`https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:csv&sheet=${encodeURIComponent(SHEET_NAME)}`;

/* ====== æ­£å¼ 6 é …ç›®ï¼ˆåªå‘¢å•²å…ˆè¨ˆï¼‰ ====== */
const EVENTS=["é …ç›®ä¸€","é …ç›®äºŒ","é …ç›®ä¸‰","é …ç›®å››","é …ç›®äº”","é …ç›®å…­"];

let currentView="team";

/* ====== Utils ====== */
function parseCSV(t){
 const r=t.trim().split("\n").map(l=>l.split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/).map(c=>c.replace(/^"|"$/g,"")));
 const h=r.shift();
 return r.map(x=>Object.fromEntries(h.map((k,i)=>[k,x[i]])));
}
const team=id=>id.slice(0,2);
const member=id=>id.slice(2);

/* ====== PIN ====== */
function checkPin(){
 if(document.getElementById("pinInput").value===PIN){
  document.getElementById("pinLock").style.display="none";
  load();
 }else{
  document.getElementById("pinError").innerText="PIN éŒ¯èª¤";
 }
}

/* ====== View ====== */
function switchView(v){
 currentView=v;
 document.getElementById("btn-team").classList.toggle("active",v==="team");
 document.getElementById("btn-event").classList.toggle("active",v==="event");
 load();
}

/* ====== Main ====== */
async function load(){
 const res=await fetch(CSV_URL);
 const data=parseCSV(await res.text());
 const now=new Date();

 currentView==="team"
  ? renderByTeam(data)
  : renderByEvent(data);

 document.getElementById("update").innerText="æœ€å¾Œæ›´æ–°ï¼š"+now.toLocaleTimeString();
}

/* ====== Team Viewï¼ˆç´…æ©™ç¶ ï¼‰ ====== */
function renderByTeam(data){
 const box=document.getElementById("view");
 box.innerHTML="";
 const seen=new Set();
 const map={};

 data.forEach(r=>{
  if(!EVENTS.includes(r["ç°½åˆ°é …ç›®"]))return;

  const key=r["æˆå“¡ ID"]+"|"+r["ç°½åˆ°é …ç›®"];
  if(seen.has(key))return;
  seen.add(key);

  const t=team(r["æˆå“¡ ID"]);
  const m=member(r["æˆå“¡ ID"]);

  map[t]??={};
  map[t][m]??=new Set();
  map[t][m].add(r["ç°½åˆ°é …ç›®"]);
 });

 for(const t in map){
  const div=document.createElement("div");
  div.className="block";
  div.innerHTML=`<h3>${t}éšŠ</h3>`;

  const wrap=document.createElement("div");
  wrap.className="team";

  for(const m in map[t]){
   const count=map[t][m].size;
   const cls=count===6?"green":count>0?"orange":"red";
   wrap.innerHTML+=
    `<span class="member ${cls}">${m} (${count}/6)</span>`;
  }

  div.appendChild(wrap);
  box.appendChild(div);
 }
}

/* ====== Event Viewï¼ˆä¿ç•™åŸæœ¬ï¼‰ ====== */
function renderByEvent(data){
 const box=document.getElementById("view");
 box.innerHTML="";
 const seen=new Set();
 const map={};

 data.forEach(r=>{
  if(!EVENTS.includes(r["ç°½åˆ°é …ç›®"]))return;

  const key=r["æˆå“¡ ID"]+"|"+r["ç°½åˆ°é …ç›®"];
  if(seen.has(key))return;
  seen.add(key);

  const e=r["ç°½åˆ°é …ç›®"];
  const t=team(r["æˆå“¡ ID"]);
  const m=member(r["æˆå“¡ ID"]);

  map[e]??={};
  map[e][t]??=[];
  map[e][t].push(m);
 });

 for(const e in map){
  const div=document.createElement("div");
  div.className="block";
  div.innerHTML=`<h3>${e}</h3>`;
  for(const t in map[e]){
   const arr=map[e][t];
   div.innerHTML+=`
    <div class="team">
     ${t}éšŠï¼š${arr.join(" ")}
     <span class="${arr.length===6?"green":"red"}">
      ${arr.length===6?" âœ…":" âŒ"}
     </span>
    </div>`;
  }
  box.appendChild(div);
 }
}
</script>

</body>
</html>