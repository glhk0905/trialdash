<!DOCTYPE html>
<html lang="zh-HK">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Dashboard B</title>

<style>
body{font-family:Arial;background:#000;color:#fff;margin:0;padding:14px}
h2{margin:6px 0}
button{background:#222;color:#fff;border:none;padding:8px 14px;margin:4px;border-radius:8px}
button.active{background:#4CAF50}
.block{border:1px solid #333;border-radius:12px;padding:12px;margin-bottom:14px}
.team{margin-left:14px;margin-top:8px}
.member{display:inline-block;padding:6px 10px;border-radius:8px;margin:4px;cursor:pointer}
.green{background:#2E7D32}
.orange{background:#EF6C00}
.red{background:#B71C1C}
.small{font-size:13px;color:#aaa}

dialog{
 border:none;border-radius:12px;
 padding:16px;background:#111;color:#fff;
 width:90%;max-width:420px
}
dialog::backdrop{background:rgba(0,0,0,.7)}
</style>
</head>

<body>

<!-- PIN -->
<div id="pinLock" style="position:fixed;inset:0;background:#000;display:flex;flex-direction:column;justify-content:center;align-items:center">
 <h2>ğŸ” è¼¸å…¥ PIN</h2>
 <input id="pinInput" type="password" maxlength="4"
        style="font-size:20px;padding:8px;width:120px;text-align:center">
 <button onclick="checkPin()">é€²å…¥</button>
 <div id="pinError" class="small"></div>
</div>

<h2>ğŸ“Š Dashboard B</h2>

<div>
 <button id="btn-team" class="active" onclick="switchView('team')">ä¾éšŠä¼</button>
 <button id="btn-event" onclick="switchView('event')">ä¾é …ç›®</button>
</div>

<div id="view"></div>
<div class="small" id="update"></div>

<dialog id="detailDialog"></dialog>

<script>
/* ===== åŸºæœ¬è¨­å®š ===== */
const PIN="9838";
const SHEET_ID="1dwK703awpcqW6A3BofDA8cjNSlER2C2Tz5wIu7wr6XQ";
const SHEET_NAME="è¡¨å–®å›æ‡‰ 1";
const CSV_URL=
 `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:csv&sheet=${encodeURIComponent(SHEET_NAME)}`;

const EVENTS=["é …ç›®ä¸€","é …ç›®äºŒ","é …ç›®ä¸‰","é …ç›®å››","é …ç›®äº”","é …ç›®å…­"];

let currentView="team";
let cache=[];

/* ===== å·¥å…· ===== */
function parseCSV(t){
 const r=t.trim().split("\n")
  .map(l=>l.split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/)
  .map(c=>c.replace(/^"|"$/g,"")));
 const h=r.shift();
 return r.map(x=>Object.fromEntries(h.map((k,i)=>[k,x[i]])));
}
const team=id=>id.slice(0,2);
const member=id=>id.slice(2);

/* ===== PIN ===== */
function checkPin(){
 if(pinInput.value===PIN){
  pinLock.style.display="none";
  load();
  setInterval(load,5000); // å³æ™‚æ›´æ–°
 }else{
  pinError.innerText="PIN éŒ¯èª¤";
 }
}

/* ===== View ===== */
function switchView(v){
 currentView=v;
 btn-team.classList.toggle("active",v==="team");
 btn-event.classList.toggle("active",v==="event");
 render();
}

/* ===== Load ===== */
async function load(){
 const res=await fetch(CSV_URL+"&_="+Date.now());
 cache=parseCSV(await res.text());
 render();
 update.innerText="æœ€å¾Œæ›´æ–°ï¼š"+new Date().toLocaleTimeString();
}

/* ===== Render ===== */
function render(){
 currentView==="team"?renderTeam():renderEvent();
}

/* ===== ä¾éšŠä¼æª¢è¦–ï¼ˆâœ… å·²æ’åºï¼‰ ===== */
function renderTeam(){
 view.innerHTML="";
 const seen=new Set();
 const map={};
 const first=new Set();

 cache.forEach(r=>{
  if(r["ç°½åˆ°é …ç›®"]==="é¦–æ¬¡å ±åˆ°"){
   first.add(r["æˆå“¡ ID"]);
   return;
  }
  if(!EVENTS.includes(r["ç°½åˆ°é …ç›®"]))return;

  const key=r["æˆå“¡ ID"]+"|"+r["ç°½åˆ°é …ç›®"];
  if(seen.has(key))return;
  seen.add(key);

  const t=team(r["æˆå“¡ ID"]);
  const m=member(r["æˆå“¡ ID"]);
  map[t]??={};
  map[t][m]??=new Set();
  map[t][m].add(r["ç°½åˆ°é …ç›®"]);
 });

 Object.keys(map)
  .sort((a,b)=>Number(a)-Number(b))   // âœ… éšŠè™Ÿæ’åº
  .forEach(t=>{
   const div=document.createElement("div");
   div.className="block";
   div.innerHTML=`<h3>${t}éšŠ</h3>`;

   const box=document.createElement("div");
   box.className="team";

   Object.keys(map[t])
    .sort((a,b)=>Number(a)-Number(b)) // âœ… æˆå“¡æ’åº
    .forEach(m=>{
     const id=t+m;
     const done=map[t][m].size;

     let cls="red";
     if(first.has(id) && done>0) cls="green";
     else if(first.has(id) && done===0) cls="orange";

     const span=document.createElement("span");
     span.className=`member ${cls}`;
     span.innerText=m;
     span.onclick=()=>showDetail(t,m,map[t][m],first.has(id));
     box.appendChild(span);
    });

   div.appendChild(box);
   view.appendChild(div);
  });
}

/* ===== Dialog ===== */
function showDetail(t,m,set,hasFirst){
 detailDialog.innerHTML=`
  <h3>${t}éšŠ ${m}</h3>
  <p>ğŸ“Œ é¦–æ¬¡å ±åˆ°ï¼š${hasFirst?"âœ… å·²å®Œæˆ":"âŒ æœªå®Œæˆ"}</p>
  <p>âœ… å·²å®Œæˆé …ç›®ï¼š</p>
  <ul>${[...set].map(x=>`<li>${x}</li>`).join("")||"<li>â€”</li>"}</ul>
  <p>âŒ å°šæœªå®Œæˆï¼š</p>
  <ul>${EVENTS.filter(e=>!set.has(e)).map(x=>`<li>${x}</li>`).join("")}</ul>
  <button onclick="detailDialog.close()">é—œé–‰</button>
 `;
 detailDialog.showModal();
}

/* ===== ä¾é …ç›®æª¢è¦–ï¼ˆåŸæ¨£ï¼‰ ===== */
function renderEvent(){
 view.innerHTML="";
 const seen=new Set();
 const map={};

 cache.forEach(r=>{
  if(!EVENTS.includes(r["ç°½åˆ°é …ç›®"]))return;
  const key=r["æˆå“¡ ID"]+"|"+r["ç°½åˆ°é …ç›®"];
  if(seen.has(key))return;
  seen.add(key);

  const e=r["ç°½åˆ°é …ç›®"];
  const t=team(r["æˆå“¡ ID"]);
  const m=member(r["æˆå“¡ ID"]);
  map[e]??={};
  map[e][t]??=[];
  map[e][t].push(m);
 });

 Object.keys(map).forEach(e=>{
  const div=document.createElement("div");
  div.className="block";
  div.innerHTML=`<h3>${e}</h3>`;
  Object.keys(map[e])
   .sort((a,b)=>Number(a)-Number(b))
   .forEach(t=>{
    const arr=map[e][t].sort((a,b)=>Number(a)-Number(b));
    div.innerHTML+=`
     <div class="team">
      ${t}éšŠï¼š${arr.join(" ")}
      <span class="${arr.length===6?"green":"red"}">
       ${arr.length===6?" âœ…":" âŒ"}
      </span>
     </div>`;
   });
  view.appendChild(div);
 });
}
</script>

</body>
</html>