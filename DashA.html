<!DOCTYPE html>
<html lang="zh-HK">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Dashboard Aï½œé …ç›®å³æ™‚ç›£æ§</title>

<style>
body{
  font-family: Arial, Helvetica, sans-serif;
  background:#000;
  color:#fff;
  margin:0;
  padding:12px;
}
h2{margin-top:0}
.event{
  border:1px solid #333;
  border-radius:12px;
  padding:12px;
  margin-bottom:14px;
}
.event h3{
  margin:0 0 8px 0;
}
.team{
  margin-left:12px;
  margin-top:6px;
}
.ok{color:#4CAF50}
.bad{color:#E53935}
.small{font-size:13px;color:#aaa}
</style>
</head>

<body>
<h2>ğŸ“± é …ç›®ç›£æ§ï¼ˆè¿‘ 35 åˆ†é˜ï¼‰</h2>
<div class="small" id="lastUpdate"></div>
<div id="app">è¼‰å…¥ä¸­â€¦</div>

<script>
/* ===== åŸºæœ¬è¨­å®š ===== */
const WINDOW_MIN = 35;
const SHEET_ID = "1dwK703awpcqW6A3BofDA8cjNSlER2C2Tz5wIu7wr6XQ";
const SHEET_NAME = "è¡¨å–®å›æ‡‰ 1";

/* Google Sheet è½‰ CSV */
const CSV_URL =
  `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:csv&sheet=${encodeURIComponent(SHEET_NAME)}`;

function parseCSV(text){
  const rows = text.trim().split("\n").map(r =>
    r.split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/).map(c => c.replace(/^"|"$/g,""))
  );
  const headers = rows.shift();
  return rows.map(r => Object.fromEntries(headers.map((h,i)=>[h,r[i]])));
}

function teamFromId(id){
  return id.slice(0,2);
}
function memberFromId(id){
  return id.slice(2);
}

async function load(){
  const res = await fetch(CSV_URL);
  const text = await res.text();
  const data = parseCSV(text);

  const now = new Date();
  const cutoff = new Date(now - WINDOW_MIN*60*1000);

  // éæ¿¾ 35 åˆ†é˜å…§
  const recent = data.filter(r=>{
    const t = new Date(r["æ™‚é–“æˆ³è¨˜"]);
    return t >= cutoff;
  });

  // å»é‡ï¼šæˆå“¡ + é …ç›®
  const seen = new Set();
  const clean = recent.filter(r=>{
    const key = r["æˆå“¡ ID"]+"|"+r["ç°½åˆ°é …ç›®"];
    if(seen.has(key)) return false;
    seen.add(key);
    return true;
  });

  // event â†’ team â†’ members
  const map = {};
  clean.forEach(r=>{
    const event = r["ç°½åˆ°é …ç›®"];
    if(event === "é¦–æ¬¡å ±åˆ°") return;

    const team = teamFromId(r["æˆå“¡ ID"]);
    const member = memberFromId(r["æˆå“¡ ID"]);

    map[event] ??= {};
    map[event][team] ??= [];
    map[event][team].push(member);
  });

  render(map);
  document.getElementById("lastUpdate").innerText =
    "æœ€å¾Œæ›´æ–°ï¼š" + now.toLocaleTimeString();
}

function render(map){
  const app = document.getElementById("app");
  app.innerHTML = "";

  if(Object.keys(map).length === 0){
    app.innerHTML = "<div class='small'>è¿‘ 35 åˆ†é˜å…§æ²’æœ‰é …ç›®ç°½åˆ°</div>";
    return;
  }

  for(const event in map){
    const div = document.createElement("div");
    div.className = "event";

    let total = 0;
    Object.values(map[event]).forEach(arr=>total+=arr.length);

    div.innerHTML = `<h3>${event}ï¼ˆ${total} äººï¼‰</h3>`;

    for(const team in map[event]){
      const members = map[event][team];
      const ok = members.length === 6;
      div.innerHTML += `
        <div class="team">
          ${team}éšŠï¼š
          ${members.join(" ")}
          <span class="${ok?"ok":"bad"}">
            ${ok?"âœ…":"âŒ"}
          </span>
        </div>
      `;
    }
    app.appendChild(div);
  }
}

load();
setInterval(load, 60*1000);
</script>
</body>
</html>